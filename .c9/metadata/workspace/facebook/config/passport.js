{"filter":false,"title":"passport.js","tooltip":"/facebook/config/passport.js","undoManager":{"mark":1,"position":1,"stack":[[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":122,"column":2},"action":"remove","lines":["var facebookStrategy = require(\"passport-facebook\").Strategy;","var async = require(\"async\");","var authConfig = require(\"./auth\");","var mysql = require(\"mysql\");","var dbConfig = require(\"./database\");","var connectionPool = mysql.createPool(dbConfig);","var logger = require(\"./logger\");","","module.exports = function(passport) {","    //직렬화","    passport.serializeUser(function(user, done) {","        logger.debug('passport.serializeUser', user);","        done(null, user.id);","    });","","    //역직렬화","    passport.deserializeUser(function(id, done) {","        connectionPool.getConnection(function(err, conn) {","            if (err) {","                return done(err);","            }","            var sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users WHERE id=?';","            conn.query(sql, [id], function(err, rows, fields) {","                if (err) {","                    return done(err);","                }","                console.log('rows', rows);","                var row = rows[0];","                var user = {};","                user.id = row.id;","                user.facebookId = row.facebook_id;","                user.facebookUsername = row.facebook_username;","                user.facebookToken = row.facebook_token;","                user.facebookEmail = row.facebook_email;","                user.facebookName = row.facebook_name;","                user.facebookPhoto = row.facebook_photo;","","                conn.release();","                logger.debug('passport.deserializeUser', user);","                return done(null, user);","            });","        });","    }); //deserializeUser","","    //인증","    passport.use(new facebookStrategy({","            clientID: authConfig.facebookAuth.clientID,","            clientSecret: authConfig.facebookAuth.clientSecret,","            callbackURL: authConfig.facebookAuth.callbackURL,","            profileFields : ['id', 'displayName', 'name', 'emails', 'photos']","        }, //로그인 시점","","        function(accessToken, refreshToken, profile, done) { //토근 얻은 시점","            process.nextTick(function() {","                connectionPool.getConnection(function(err, conn) {","                    if (err) {","                        return done(err);","                    }","                    var facebookPhoto = profile.photos[0].value;","                    var sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users WHERE facebook_id=?';","                    conn.query(sql, [profile.id], function(err, rows, fields) {","                        if (err) {","                            conn.release();","                            return done(err);","                        }","                        if (rows.length) { //db에 사용자가 있을 때","                            var user = {};","                            var row = rows[0];","                            user.id = row.id;","                            user.facebookId = row.facebook_id;","                            user.facebookUsername = row.facebook_username;","                            user.facebookToken = row.facebook_token;","                            user.facebookEmail = row.facebook_email;","                            user.facebookName = row.facebook_name;","                            user.facebookPhoto = row.facebook_photo;","","                            if (accessToken !== user.facebookToken) { //토큰 변경된경우","                                //DB 테이블 업데이트","                                var updateSQL = 'UPDATE users SET facebook_token=?, facebook_photo=? WHERE facebook_id=?';","                                conn.query(updateSQL, [accessToken, facebookPhoto, profile.id], function(err, result) {","                                    conn.release();","                                    if (err) {","                                        return done(err);","                                    }","                                    return done(null, user);","                                });","                            }","                            else { //토큰 변경이 안된 경우","                                conn.release();","                                return done(null, user);","                            }","                        }","","                        else { //db에 사용자가 없을 때","                            var newUser = {};","                            newUser.facebookId = profile.id;","                            newUser.facebookUsername = profile.displayName; //displayName : 박성백","                            newUser.facebookToken = accessToken;","                            newUser.facebookEmail = profile.emails[0].value;","                            newUser.facebookName = profile.name.givenName + ' ' + profile.name.familyName;","                            //newUser.facebookPhoto = \"https://graph.facebook.com/v2.2/me/picture?accessToken=\" + accessToken;","                            newUser.facebookPhoto = profile.photos[0].value;","                            var datas = [newUser.facebookId, newUser.facebookUsername, newUser.facebookToken, newUser.facebookEmail, newUser.facebookName, newUser.facebookPhoto];","","                            //DB에 저장","                            var insertSQL = 'INSERT INTO users(facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo) VALUES(?,?,?,?,?,?)';","                            conn.query(insertSQL, datas, function(err, result) {","                                if (err) {","                                    conn.release();","                                    return done(err);","                                }","                                newUser.id = result.insertId; //저장 후 증가된 id값","                                conn.release();","                                return done(null, newUser);","                            });","                        }","                        ","                    });","                });","            });","        }","    )); //use","};"]},{"start":{"row":0,"column":0},"end":{"row":109,"column":0},"action":"insert","lines":["// config/passport.js","","var FacebookStrategy = require('passport-facebook').Strategy;","var async = require('async');","var authConfig = require('./auth');","var mysql = require('mysql');","var dbConfig = require('./database');","var connectionPool = mysql.createPool(dbConfig);","var logger = require('./logger');","","module.exports = function(passport) {","\t// 직렬화","\tpassport.serializeUser(function(user, done) {","\t\tlogger.debug('passport.serializeUser', user);","\t\tdone(null, user.id);","\t});","","\t// 역직렬화","\tpassport.deserializeUser(function(id, done) {","\t\tconnectionPool.getConnection(function(err, conn) {","\t\t\tif(err) { return done(err); }","\t\t\tvar sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users where id=?';","\t\t\tconn.query(sql, [id], function(err, rows, fields) {","\t\t\t\tconsole.log('rows', rows);","\t\t\t\tvar row = rows[0];","\t\t\t\tvar user = {};","\t\t\t\tuser.id = row.id;","\t\t\t\tuser.facebookId = row.facebook_id;","\t\t\t\tuser.facebookUsername = row.facebook_username;","\t\t\t\tuser.facebookToken = row.facebook_token;","\t\t\t\tuser.facebookEmail = row.facebook_email;","\t\t\t\tuser.facebookName = row.facebook_name;","\t\t\t\tuser.facebookPhoto = row.facebook_photo;","\t\t\t\tconn.release();","\t\t\t\tlogger.debug('passport.deserializeUser', user);","\t\t\t\treturn done(null, user);","\t\t\t});","\t\t});","\t});// deserializeUser","","\t// 인증","\tpassport.use(new FacebookStrategy({","\t\tclientID : authConfig.facebookAuth.clientID,","\t\tclientSecret : authConfig.facebookAuth.clientSecret,","\t\tcallbackURL : authConfig.facebookAuth.callbackURL,","\t\tprofileFields : [ 'id', 'displayName', 'name', 'emails', 'photos' ]","\t},","\tfunction(accessToken, refreshToken, profile, done) {","\t\tprocess.nextTick(function() {","\t\t\tconnectionPool.getConnection(function(err, conn) {","\t\t\t\tif(err) { return done(err); }","\t\t\t\tvar facebookPhoto = profile.photos[0].value;","\t\t\t\tvar sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users where facebook_id=?';","\t\t\t\tconn.query(sql, [profile.id], function(err, rows, fields) {","\t\t\t\t\tif(err) {","\t\t\t\t\t\tconn.release();","\t\t\t\t\t\treturn done(err);","\t\t\t\t\t}","\t\t\t\t\tif(rows.length) { // DB에 사용자가 있을 때","\t\t\t\t\t\tvar user = {};","\t\t\t\t\t\tvar row = rows[0];","\t\t\t\t\t\tuser.id = row.id;","\t\t\t\t\t\tuser.facebookId = row.facebook_id;","\t\t\t\t\t\tuser.facebookUsername = row.facebook_username;","\t\t\t\t\t\tuser.facebookToken = row.facebook_token;","\t\t\t\t\t\tuser.facebookEmail = row.facebook_email;","\t\t\t\t\t\tuser.facebookName = row.facebook_name;","\t\t\t\t\t\tuser.facebookPhoto = row.facebook_photo;","\t\t\t\t\t\tif(accessToken !== user.facebookToken) { // 토큰 변경된 경우","\t\t\t\t\t\t\t// DB 테이블 업데이트","\t\t\t\t\t\t\tvar updateSql = 'UPDATE users SET facebook_token=?, facebook_photo=? WHERE facebook_id=?';","\t\t\t\t\t\t\tconn.query(updateSql, [accessToken, facebookPhoto, profile.id], function(err, result) {","\t\t\t\t\t\t\t\tif(err) {","\t\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\t\treturn done(err);","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\treturn done(null, user);","\t\t\t\t\t\t\t});","\t\t\t\t\t\t} else { // 토큰 변경 X","\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\treturn done(null, user);","\t\t\t\t\t\t}","\t\t\t\t\t} else { // DB에 사용자 없을 때","\t\t\t\t\t\tvar newUser = {};","\t\t\t\t\t\tnewUser.facebookId = profile.id;","\t\t\t\t\t\tnewUser.facebookUsername = profile.displayName;","\t\t\t\t\t\tnewUser.facebookToken = accessToken;","\t\t\t\t\t\tnewUser.facebookEmail = profile.emails[0].value;","\t\t\t\t\t\tnewUser.facebookName = profile.name.givenName + ' ' + profile.name.familyName;","\t\t\t\t\t\tnewUser.facebookPhoto = profile.photos[0].value;","\t\t\t\t\t\t// DB 에 insert","\t\t\t\t\t\tvar insertSql = 'INSERT INTO users(facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo) VALUES(?,?,?,?,?,?)';","\t\t\t\t\t\tconn.query(insertSql, [newUser.facebookId, newUser.facebookUsername, newUser.facebookToken, newUser.facebookEmail, newUser.facebookName, newUser.facebookPhoto], function(err, result) {","\t\t\t\t\t\t\tif(err) {","\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\treturn done(err);","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\tnewUser.id = result.insertId; // 저장 후 증가된 id 값","\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\treturn done(null, newUser);","\t\t\t\t\t\t});","\t\t\t\t\t}","\t\t\t\t});","\t\t\t});","\t\t});","\t}));// use","","};",""]}]}],[{"group":"doc","deltas":[{"start":{"row":0,"column":0},"end":{"row":109,"column":0},"action":"remove","lines":["// config/passport.js","","var FacebookStrategy = require('passport-facebook').Strategy;","var async = require('async');","var authConfig = require('./auth');","var mysql = require('mysql');","var dbConfig = require('./database');","var connectionPool = mysql.createPool(dbConfig);","var logger = require('./logger');","","module.exports = function(passport) {","\t// 직렬화","\tpassport.serializeUser(function(user, done) {","\t\tlogger.debug('passport.serializeUser', user);","\t\tdone(null, user.id);","\t});","","\t// 역직렬화","\tpassport.deserializeUser(function(id, done) {","\t\tconnectionPool.getConnection(function(err, conn) {","\t\t\tif(err) { return done(err); }","\t\t\tvar sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users where id=?';","\t\t\tconn.query(sql, [id], function(err, rows, fields) {","\t\t\t\tconsole.log('rows', rows);","\t\t\t\tvar row = rows[0];","\t\t\t\tvar user = {};","\t\t\t\tuser.id = row.id;","\t\t\t\tuser.facebookId = row.facebook_id;","\t\t\t\tuser.facebookUsername = row.facebook_username;","\t\t\t\tuser.facebookToken = row.facebook_token;","\t\t\t\tuser.facebookEmail = row.facebook_email;","\t\t\t\tuser.facebookName = row.facebook_name;","\t\t\t\tuser.facebookPhoto = row.facebook_photo;","\t\t\t\tconn.release();","\t\t\t\tlogger.debug('passport.deserializeUser', user);","\t\t\t\treturn done(null, user);","\t\t\t});","\t\t});","\t});// deserializeUser","","\t// 인증","\tpassport.use(new FacebookStrategy({","\t\tclientID : authConfig.facebookAuth.clientID,","\t\tclientSecret : authConfig.facebookAuth.clientSecret,","\t\tcallbackURL : authConfig.facebookAuth.callbackURL,","\t\tprofileFields : [ 'id', 'displayName', 'name', 'emails', 'photos' ]","\t},","\tfunction(accessToken, refreshToken, profile, done) {","\t\tprocess.nextTick(function() {","\t\t\tconnectionPool.getConnection(function(err, conn) {","\t\t\t\tif(err) { return done(err); }","\t\t\t\tvar facebookPhoto = profile.photos[0].value;","\t\t\t\tvar sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users where facebook_id=?';","\t\t\t\tconn.query(sql, [profile.id], function(err, rows, fields) {","\t\t\t\t\tif(err) {","\t\t\t\t\t\tconn.release();","\t\t\t\t\t\treturn done(err);","\t\t\t\t\t}","\t\t\t\t\tif(rows.length) { // DB에 사용자가 있을 때","\t\t\t\t\t\tvar user = {};","\t\t\t\t\t\tvar row = rows[0];","\t\t\t\t\t\tuser.id = row.id;","\t\t\t\t\t\tuser.facebookId = row.facebook_id;","\t\t\t\t\t\tuser.facebookUsername = row.facebook_username;","\t\t\t\t\t\tuser.facebookToken = row.facebook_token;","\t\t\t\t\t\tuser.facebookEmail = row.facebook_email;","\t\t\t\t\t\tuser.facebookName = row.facebook_name;","\t\t\t\t\t\tuser.facebookPhoto = row.facebook_photo;","\t\t\t\t\t\tif(accessToken !== user.facebookToken) { // 토큰 변경된 경우","\t\t\t\t\t\t\t// DB 테이블 업데이트","\t\t\t\t\t\t\tvar updateSql = 'UPDATE users SET facebook_token=?, facebook_photo=? WHERE facebook_id=?';","\t\t\t\t\t\t\tconn.query(updateSql, [accessToken, facebookPhoto, profile.id], function(err, result) {","\t\t\t\t\t\t\t\tif(err) {","\t\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\t\treturn done(err);","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\treturn done(null, user);","\t\t\t\t\t\t\t});","\t\t\t\t\t\t} else { // 토큰 변경 X","\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\treturn done(null, user);","\t\t\t\t\t\t}","\t\t\t\t\t} else { // DB에 사용자 없을 때","\t\t\t\t\t\tvar newUser = {};","\t\t\t\t\t\tnewUser.facebookId = profile.id;","\t\t\t\t\t\tnewUser.facebookUsername = profile.displayName;","\t\t\t\t\t\tnewUser.facebookToken = accessToken;","\t\t\t\t\t\tnewUser.facebookEmail = profile.emails[0].value;","\t\t\t\t\t\tnewUser.facebookName = profile.name.givenName + ' ' + profile.name.familyName;","\t\t\t\t\t\tnewUser.facebookPhoto = profile.photos[0].value;","\t\t\t\t\t\t// DB 에 insert","\t\t\t\t\t\tvar insertSql = 'INSERT INTO users(facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo) VALUES(?,?,?,?,?,?)';","\t\t\t\t\t\tconn.query(insertSql, [newUser.facebookId, newUser.facebookUsername, newUser.facebookToken, newUser.facebookEmail, newUser.facebookName, newUser.facebookPhoto], function(err, result) {","\t\t\t\t\t\t\tif(err) {","\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\treturn done(err);","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\tnewUser.id = result.insertId; // 저장 후 증가된 id 값","\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\treturn done(null, newUser);","\t\t\t\t\t\t});","\t\t\t\t\t}","\t\t\t\t});","\t\t\t});","\t\t});","\t}));// use","","};",""]},{"start":{"row":0,"column":0},"end":{"row":109,"column":0},"action":"insert","lines":["// config/passport.js","","var FacebookStrategy = require('passport-facebook').Strategy;","var async = require('async');","var authConfig = require('./auth');","var mysql = require('mysql');","var dbConfig = require('./database');","var connectionPool = mysql.createPool(dbConfig);","var logger = require('./logger');","","module.exports = function(passport) {","\t// 직렬화","\tpassport.serializeUser(function(user, done) {","\t\tlogger.debug('passport.serializeUser', user);","\t\tdone(null, user.id);","\t});","","\t// 역직렬화","\tpassport.deserializeUser(function(id, done) {","\t\tconnectionPool.getConnection(function(err, conn) {","\t\t\tif(err) { return done(err); }","\t\t\tvar sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users where id=?';","\t\t\tconn.query(sql, [id], function(err, rows, fields) {","\t\t\t\tconsole.log('rows', rows);","\t\t\t\tvar row = rows[0];","\t\t\t\tvar user = {};","\t\t\t\tuser.id = row.id;","\t\t\t\tuser.facebookId = row.facebook_id;","\t\t\t\tuser.facebookUsername = row.facebook_username;","\t\t\t\tuser.facebookToken = row.facebook_token;","\t\t\t\tuser.facebookEmail = row.facebook_email;","\t\t\t\tuser.facebookName = row.facebook_name;","\t\t\t\tuser.facebookPhoto = row.facebook_photo;","\t\t\t\tconn.release();","\t\t\t\tlogger.debug('passport.deserializeUser', user);","\t\t\t\treturn done(null, user);","\t\t\t});","\t\t});","\t});// deserializeUser","","\t// 인증","\tpassport.use(new FacebookStrategy({","\t\tclientID : authConfig.facebookAuth.clientID,","\t\tclientSecret : authConfig.facebookAuth.clientSecret,","\t\tcallbackURL : authConfig.facebookAuth.callbackURL,","\t\tprofileFields : [ 'id', 'displayName', 'name', 'emails', 'photos' ]","\t},","\tfunction(accessToken, refreshToken, profile, done) {","\t\tprocess.nextTick(function() {","\t\t\tconnectionPool.getConnection(function(err, conn) {","\t\t\t\tif(err) { return done(err); }","\t\t\t\tvar facebookPhoto = profile.photos[0].value;","\t\t\t\tvar sql = 'SELECT id, facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo FROM users where facebook_id=?';","\t\t\t\tconn.query(sql, [profile.id], function(err, rows, fields) {","\t\t\t\t\tif(err) {","\t\t\t\t\t\tconn.release();","\t\t\t\t\t\treturn done(err);","\t\t\t\t\t}","\t\t\t\t\tif(rows.length) { // DB에 사용자가 있을 때","\t\t\t\t\t\tvar user = {};","\t\t\t\t\t\tvar row = rows[0];","\t\t\t\t\t\tuser.id = row.id;","\t\t\t\t\t\tuser.facebookId = row.facebook_id;","\t\t\t\t\t\tuser.facebookUsername = row.facebook_username;","\t\t\t\t\t\tuser.facebookToken = row.facebook_token;","\t\t\t\t\t\tuser.facebookEmail = row.facebook_email;","\t\t\t\t\t\tuser.facebookName = row.facebook_name;","\t\t\t\t\t\tuser.facebookPhoto = row.facebook_photo;","\t\t\t\t\t\tif(accessToken !== user.facebookToken) { // 토큰 변경된 경우","\t\t\t\t\t\t\t// DB 테이블 업데이트","\t\t\t\t\t\t\tvar updateSql = 'UPDATE users SET facebook_token=?, facebook_photo=? WHERE facebook_id=?';","\t\t\t\t\t\t\tconn.query(updateSql, [accessToken, facebookPhoto, profile.id], function(err, result) {","\t\t\t\t\t\t\t\tif(err) {","\t\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\t\treturn done(err);","\t\t\t\t\t\t\t\t}","\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\treturn done(null, user);","\t\t\t\t\t\t\t});","\t\t\t\t\t\t} else { // 토큰 변경 X","\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\treturn done(null, user);","\t\t\t\t\t\t}","\t\t\t\t\t} else { // DB에 사용자 없을 때","\t\t\t\t\t\tvar newUser = {};","\t\t\t\t\t\tnewUser.facebookId = profile.id;","\t\t\t\t\t\tnewUser.facebookUsername = profile.displayName;","\t\t\t\t\t\tnewUser.facebookToken = accessToken;","\t\t\t\t\t\tnewUser.facebookEmail = profile.emails[0].value;","\t\t\t\t\t\tnewUser.facebookName = profile.name.givenName + ' ' + profile.name.familyName;","\t\t\t\t\t\tnewUser.facebookPhoto = profile.photos[0].value;","\t\t\t\t\t\t// DB 에 insert","\t\t\t\t\t\tvar insertSql = 'INSERT INTO users(facebook_id, facebook_username, facebook_token, facebook_email, facebook_name, facebook_photo) VALUES(?,?,?,?,?,?)';","\t\t\t\t\t\tconn.query(insertSql, [newUser.facebookId, newUser.facebookUsername, newUser.facebookToken, newUser.facebookEmail, newUser.facebookName, newUser.facebookPhoto], function(err, result) {","\t\t\t\t\t\t\tif(err) {","\t\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\t\treturn done(err);","\t\t\t\t\t\t\t}","\t\t\t\t\t\t\tnewUser.id = result.insertId; // 저장 후 증가된 id 값","\t\t\t\t\t\t\tconn.release();","\t\t\t\t\t\t\treturn done(null, newUser);","\t\t\t\t\t\t});","\t\t\t\t\t}","\t\t\t\t});","\t\t\t});","\t\t});","\t}));// use","","};",""]}]}]]},"ace":{"folds":[],"scrolltop":60,"scrollleft":0,"selection":{"start":{"row":24,"column":21},"end":{"row":25,"column":10},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":3,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1422497291637,"hash":"bc2f0c6927432188da7605a92be5d8647cad470e"}